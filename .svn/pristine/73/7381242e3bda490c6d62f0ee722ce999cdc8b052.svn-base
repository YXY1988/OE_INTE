#pragma once
#include "YXYUtils.h"
using namespace yxy;

#include <osgViewer/Viewer>
#include <osgViewer/api/win32/GraphicsWindowWin32>
#include <osgGA/TrackballManipulator>
#include <osgGA/KeySwitchMatrixManipulator>
#include <osgDB/Registry>
#include <osgDB/ReadFile>
#include <osgDB/WriteFile>
#include <osgUtil/Optimizer>
#include <string>
#include <list>
#include <osg/MatrixTransform>
#include <osg/Depth>
#include <osg/ShadeModel>


class SceneGenerator
{
public:
	SceneGenerator();
	~SceneGenerator();
	
	std::string GetModelName() const { return m_ModelName; }
	void SetModelName(std::string val) { m_ModelName = val; }
	std::string GetBgImgName() const { return m_BgImgName; }
	void SetBgImgName(std::string val) { m_BgImgName = val; }
	cv::Mat GetBgImgMat() const { return m_BgImgMat; }
	void SetBgImgMat(cv::Mat val) { m_BgImgMat = val; }
	bool GetUseImgBgFlag() const { return m_bUseImgBg; }
	void SetUseImgBgFlag(bool val) { m_bUseImgBg = val; }

	cv::Mat GetPoseMat() const { return m_PoseMat; }
	void SetPoseMat(cv::Mat val) { m_PoseMat = val; }
	cv::Mat GetCameraIntrinsic() const { return m_Intrinsic; }
	void SetCameraIntrinsic(cv::Mat val) { m_Intrinsic = val; }
	void SetViewerSize(int width, int height);
	void SetObjectSelfTransform(cv::Mat & mat);

public:
	void Initialize();
	cv::Mat GetSyntheticImg();
	static osg::Matrix toOSGMat(const cv::Mat&);

protected:
	osg::Texture2D* GetOrCreateBKTexture();



private:
	string m_ModelName;
	string m_BgImgName;
	cv::Mat m_BgImgMat;
	bool m_bUseImgBg;

	cv::Mat m_PoseMat;
	cv::Mat m_Intrinsic; //相机内参数
	int m_iViewerWidth, m_iViewerHeight;

private:
	osg::ref_ptr<osgViewer::Viewer> m_MainViewer;		//Viewer

	osg::ref_ptr<osg::Group> m_Root;				//根节点
	osg::ref_ptr<osg::MatrixTransform> m_Model;				//模型
	
	osg::ref_ptr<osg::Camera> m_BGCamera;			//背景相机
	osg::ref_ptr<osg::Texture2D> m_BGTexture;		//背景贴图

	osg::ref_ptr<osg::Image> m_FBOImage;
	osg::ref_ptr<osg::Camera> m_FBOCamera;
	osg::Matrix m_ObjectSelfTransform;
};

